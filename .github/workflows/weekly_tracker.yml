# =============================================================================
# CSF Legislative Bill Tracker — Weekly GitHub Actions Workflow
# =============================================================================
#
# Runs every Monday morning (after LegiScan publishes Sunday's updated ZIP).
# Can also be triggered manually from the GitHub Actions UI.
#
# Pipeline:
#   1. Check out the repo (includes tracked_bills.json and prior reports)
#   2. Install Python dependencies
#   3. Restore cached LegiScan ZIP (persists across runs within the same week)
#   4a. Run the tracker — fetches latest bill data, emails the internal digest
#   4b. Run the housing analyzer — scores any new/unanalyzed bills via Claude
#   4c. Generate and send the newsletter — writes + emails Local Control Intelligence
#   5. Save updated ZIP to cache for subsequent runs this week
#   6. Commit updated bill data, analysis, newsletter, and dashboard back to the repo
#
# Required GitHub secrets (Settings → Secrets and variables → Actions):
#   LEGISCAN_USER          legiscan.com login email (for ZIP auto-download)
#   LEGISCAN_PASSWORD      legiscan.com password
#   EMAIL_USER             Gmail address to send from (shared by digest + newsletter)
#   EMAIL_PASSWORD         Gmail App Password (16-char, not your account password)
#   EMAIL_RECIPIENTS       Comma-separated recipient list for the weekly digest
#   ANTHROPIC_API_KEY      Claude API key (housing analyzer + newsletter writer)
#   NEWSLETTER_RECIPIENTS  Comma-separated subscriber list for the newsletter
#
# Optional secrets (leave unset to skip that data source):
#   LEGISCAN_API_KEY   LegiScan API key (real-time data, free, ~1-2 day approval)
#   OPENSTATES_API_KEY OpenStates API key (alternative real-time source)
# =============================================================================

name: Weekly Legislative Tracker

on:
  schedule:
    # Every Monday at 6:00 AM Pacific (14:00 UTC)
    # LegiScan publishes updated ZIPs on Sundays — Monday run gets fresh data
    - cron: '0 14 * * 1'

  # Allow manual runs from the Actions tab (useful for testing or on-demand scans)
  workflow_dispatch:

jobs:
  track-bills:
    name: Fetch, process, and report CA housing bills
    runs-on: ubuntu-latest

    permissions:
      contents: write   # Required to push updated tracked_bills.json back to the repo

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Full history ensures git push works cleanly

      # -----------------------------------------------------------------------
      # 2. Python setup
      # -----------------------------------------------------------------------
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # 3. Restore cached LegiScan ZIP
      #
      # Cache key includes the ISO week number so it refreshes each Monday,
      # aligned with LegiScan's Sunday publish schedule.
      # restore-keys falls back to the previous week's ZIP if this week's
      # isn't cached yet (e.g. on the first run of a new week).
      # -----------------------------------------------------------------------
      - name: Get weekly cache key
        id: cache-key
        run: echo "week=$(date -u +'%Y-W%V')" >> $GITHUB_OUTPUT

      - name: Restore LegiScan ZIP cache
        id: zip-cache
        uses: actions/cache@v4
        with:
          path: data/legiscan/
          key: legiscan-zip-${{ steps.cache-key.outputs.week }}
          restore-keys: legiscan-zip-

      # -----------------------------------------------------------------------
      # 4. Run the tracker
      # -----------------------------------------------------------------------
      - name: Run legislative tracker
        env:
          LEGISCAN_USER:      ${{ secrets.LEGISCAN_USER }}
          LEGISCAN_PASSWORD:  ${{ secrets.LEGISCAN_PASSWORD }}
          LEGISCAN_API_KEY:   ${{ secrets.LEGISCAN_API_KEY }}
          OPENSTATES_API_KEY: ${{ secrets.OPENSTATES_API_KEY }}
          EMAIL_USER:         ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD:     ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENTS:   ${{ secrets.EMAIL_RECIPIENTS }}
        run: |
          # --email sends the HTML digest if EMAIL_USER + EMAIL_PASSWORD are set.
          # If credentials are missing the email step fails gracefully (logged, no crash).
          python agents/legislative/bill_tracker.py --email

      # -----------------------------------------------------------------------
      # 4b. Run housing analyzer
      #
      # Analyzes only bills that are missing analysis blocks (no --force).
      # New bills added by the tracker in step 4 will be analyzed here.
      # Bills with existing analysis are skipped — scores persist until manually
      # re-run with --force if a bill's scope changes.
      # -----------------------------------------------------------------------
      - name: Run housing analyzer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python agents/housing_analyzer/housing_analyzer.py

      # -----------------------------------------------------------------------
      # 4c. Generate and send newsletter
      #
      # Reads the freshly updated + analyzed tracked_bills.json, calls Claude
      # to write this week's "Local Control Intelligence" newsletter, and
      # sends it to NEWSLETTER_RECIPIENTS.
      # -----------------------------------------------------------------------
      - name: Generate and send newsletter
        env:
          ANTHROPIC_API_KEY:       ${{ secrets.ANTHROPIC_API_KEY }}
          EMAIL_USER:              ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD:          ${{ secrets.EMAIL_PASSWORD }}
          NEWSLETTER_RECIPIENTS:   ${{ secrets.NEWSLETTER_RECIPIENTS }}
        run: |
          python agents/newsletter/newsletter_writer.py --send

      # -----------------------------------------------------------------------
      # 4d. Scan news and social media
      #
      # Scans RSS feeds (CalMatters, Capitol Weekly, Google News) and optionally
      # NewsAPI for recent CA housing coverage. Produces data/media/media_digest.json
      # which social_writer.py reads to make posts news-aware.
      # No credentials required for RSS. Set NEWSAPI_KEY to enable NewsAPI.
      # Set X_BEARER_TOKEN (Basic tier, $100/mo) to enable X API search.
      # -----------------------------------------------------------------------
      - name: Scan news and social media
        env:
          NEWSAPI_KEY:     ${{ secrets.NEWSAPI_KEY }}
          X_BEARER_TOKEN:  ${{ secrets.X_BEARER_TOKEN }}
        run: |
          python agents/media/media_scanner.py

      # -----------------------------------------------------------------------
      # 4e. Generate social media content
      #
      # Reads tracked_bills.json + media_digest.json (from step 4d), calls Claude
      # to write 3 news-aware social media posts (X, Facebook, Instagram) plus
      # image briefs. Output is markdown + HTML — no credentials needed, no posting.
      # Staff copy-paste from outputs/social/ into Buffer, Hootsuite, or directly
      # into each platform's composer.
      # -----------------------------------------------------------------------
      - name: Generate social media content
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python agents/social/social_writer.py

      # -----------------------------------------------------------------------
      # 5. Commit updated outputs back to the repo
      #
      # tracked_bills.json accumulates history across weekly runs —
      # committing it back is what makes "new bill" and "status change"
      # detection work correctly on subsequent runs.
      # -----------------------------------------------------------------------
      - name: Commit updated bill data and report
        run: |
          git config user.name  "CSF Legislative Tracker"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage bill data, weekly reports, newsletter, social content, and GitHub Pages status page
          git add data/bills/tracked_bills.json
          git add outputs/weekly_reports/
          git add outputs/newsletter/
          git add outputs/social/
          git add data/media/
          git add docs/index.html

          # Only commit if something actually changed
          if git diff --staged --quiet; then
            echo "No changes to commit — bill data is unchanged since last run."
          else
            git commit -m "chore: weekly bill tracker update $(date -u +%Y-%m-%d)"
            git push
          fi
